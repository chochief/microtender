angular.module("app",["ngRoute"]),angular.module("app").config(["$routeProvider","cons",function(t,e){function n(t){var e=localStorage.getItem("api_token");return"/signin"==t?angular.isString(e)&&60==e.length?"/tenders":void 0:angular.isString(e)&&60==e.length?void 0:"/signin"}t.when("/",{templateUrl:e.lang+"/home.html",controller:"homeCtrl"}).when("/call",{templateUrl:e.lang+"/call.html",controller:"callCtrl as callCtrl"}).when("/about",{templateUrl:e.lang+"/about.html",controller:"aboutCtrl"}).when("/want",{templateUrl:e.lang+"/want.html",controller:"wantCtrl as wantCtrl"}).when("/sorry",{templateUrl:e.lang+"/sorry.html",controller:"sorryCtrl"}).when("/signin",{redirectTo:function(t,e,a){return n(e)},templateUrl:e.lang+"/signin.html",controller:"signinCtrl as signinCtrl"}).when("/messages",{templateUrl:e.lang+"/messages.html",controller:"messagesCtrl as messagesCtrl",redirectTo:function(t,e,a){return n(e)}}).when("/tenders",{templateUrl:e.lang+"/tenders.html",controller:"tendersCtrl as tendersCtrl",redirectTo:function(t,e,a){return n(e)}}).when("/managers",{templateUrl:e.lang+"/managers.html",controller:"managersCtrl as managersCtrl",redirectTo:function(t,e,a){return n(e)}}).when("/admin_cats",{templateUrl:e.lang+"/admin_cats.html",controller:"admcatsCtrl as admcatsCtrl",redirectTo:function(t,e,a){return n(e)}}).when("/admin_cities",{templateUrl:e.lang+"/admin_cities.html",controller:"admcitiesCtrl as admcitiesCtrl",redirectTo:function(t,e,a){return n(e)}}).otherwise({redirectTo:"/"})}]),angular.module("app").constant("cons",{lang:"ru",api_path:"/api/"}),angular.module("app").run(["dataFab",function(t){t.load()}]),angular.module("app").value("vals",{}),angular.module("app").factory("dataFab",["$http","$location","cons","vals",function(t,e,n,a){function i(t){s=t.data.districts,o=t.data.cities,l=t.data.cats,c=t.data.subcats}function r(t){e.path("/sorry")}service={};var s,o,l,c;return service.load=function(){t.get(n.api_path+"data").then(i,r)},service.getDistricts=function(){return s},service.getCities=function(){return o},service.getCats=function(){return l},service.getSubcats=function(){return c},service.subcatEnable=function(t){var e=_.find(c,{id:t.id});angular.isUndefined(e)||(e.enabled=t.enabled)},service.cityEnable=function(t){var e=_.find(o,{id:t.id});angular.isUndefined(e)||(e.enabled=t.enabled)},service}]),angular.module("app").factory("mainFab",["$location","$http","cons","vals",function(t,e,n,a){var i={};return i.loginRecord=function(t){localStorage.setItem("api_token",t.api_token),localStorage.setItem("username",t.username)},i.token=function(){var t=localStorage.getItem("api_token");return!(!angular.isString(t)||60!=t.length)&&"?api_token="+t},i.username=function(){return localStorage.getItem("username")},i.logout=function(t){t&&(token=i.token())&&e.post(n.api_path+"logout"+token,{}),localStorage.setItem("api_token",""),localStorage.setItem("username","")},i}]),angular.module("app").factory("managersFab",["$http","$location","mainFab","cons",function(t,e,n,a){function i(t){s=t.data.managers,s=_.map(s,function(t){return angular.isUndefined(t.site)||null==t.site||("http://"==t.site.substr(0,7).toLowerCase()?t.site=t.site.substr(7):"https://"==t.site.substr(0,8).toLowerCase()&&(t.site=t.site.substr(8))),t})}function r(t){401==t.status?(n.logout(!1),e.path("/signin")):e.path("/sorry")}service={};var s=[];return service.load=function(){var s=n.token();s?t.get(a.api_path+"manager"+s).then(i,r):(n.logout(!1),e.path("/signin"))},service.getManagers=function(){return s},service.setEnable=function(t){var e=_.find(s,{id:t.id});angular.isUndefined(e)||(e.enabled=t.enabled)},service.delete=function(t){_.remove(s,function(e){return e.id==t})},service.addManager=function(t){s.unshift(t)},service}]),angular.module("app").factory("messagesFab",["$http","$location","mainFab","cons",function(t,e,n,a){function i(t){s=t.data.messages}function r(t){401==t.status?(n.logout(!1),e.path("/signin")):e.path("/sorry")}service={};var s=[];return service.load=function(){var s=n.token();s?t.get(a.api_path+"messages"+s).then(i,r):(n.logout(!1),e.path("/signin"))},service.getMessages=function(){return s},service}]),angular.module("app").factory("tendersFab",["$http","$location","mainFab","cons",function(t,e,n,a){function i(t){s=t.data.tenders}function r(t){401==t.status?(n.logout(!1),e.path("/signin")):e.path("/sorry")}service={};var s=[];return service.load=function(){var s=n.token();s?t.get(a.api_path+"tenders"+s).then(i,r):(n.logout(!1),e.path("/signin"))},service.getTenders=function(){return s},service}]),angular.module("app").controller("aboutCtrl",function(){}),angular.module("app").controller("admcatsCtrl",["$http","$location","dataFab","mainFab","cons",function(t,e,n,a,i){function r(t){n.subcatEnable(t.data.subcat),o.disabled=!1}function s(t){401==t.status&&(a.logout(!1),e.path("/signin")),o.disabled=!1}var o=this;o.cats=function(){return n.getCats()},o.subCats=function(t){return subcats=n.getSubcats(),_.orderBy(_.filter(subcats,{cat_id:t.id}),"name")},o.on_off=function(n){var l=a.token();l?o.disabled||(o.disabled=!0,t.post(i.api_path+"subcat_on"+l,{id:n.id,enabled:!n.enabled}).then(r,s)):(a.logout(!1),e.path("/signin"))}}]),angular.module("app").controller("admcitiesCtrl",["$http","$location","cons","dataFab","mainFab",function(t,e,n,a,i){function r(t){a.cityEnable(t.data.city),o.disabled=!1}function s(t){401==t.status&&(i.logout(!1),e.path("/signin")),o.disabled=!1}var o=this;o.districts=function(){return districts=a.getDistricts()},o.districtCities=function(t){return cities=a.getCities(),_.orderBy(_.filter(cities,{district_id:t.id}),"name")},o.on_off=function(a){var l=i.token();l?o.disabled||(o.disabled=!0,t.post(n.api_path+"city_on"+l,{id:a.id,enabled:!a.enabled}).then(r,s)):(i.logout(!1),e.path("/signin"))}}]),angular.module("app").controller("bodyCtrl",["$location","mainFab",function(t,e){var n=this;n.call=function(e){t.path("/"+e)},n.logout=function(){e.logout(!0),t.path("/signin")},n.username=function(){return e.username()}}]),angular.module("app").controller("callCtrl",["$http","cons","vals",function(t,e,n){function a(t){r.msg="Ваше сообщение было успешно отправлено! Спасибо!",r.text=void 0,r.disabled=!1,r.form.$setPristine()}function i(t){angular.isArray(t)?r.msg=_.join(t.data," "):429==t.status?r.msg="Слишком много попыток. Подождите минуту!":r.msg="Ошибка: "+t.data,r.disabled=!1}var r=this;r.submit=function(n){r.disabled=!0,r.form=n,t.post(e.api_path+"messages",{name:r.name,email:r.email,phone:r.phone,text:r.text}).then(a,i)},r.formDisabled=function(){return r.disabled},r.msg="",r.showMsg=function(){return""!=r.msg},r.msgClose=function(){r.msg=""}}]),angular.module("app").controller("catCtrl",["$scope","dataFab",function(t,e){var n=this;n.subcat=t.$parent.$parent.subcat,n.subcats=t.$parent.subcats,n.cats=function(){return e.getCats()},n.subCats=function(t){return subcats=e.getSubcats(),_.orderBy(_.filter(subcats,{cat_id:t.id,enabled:1}),"name")},n.selectedCat=function(){return angular.isUndefined(t.$parent.$parent.subcat)||_.isEmpty(t.$parent.$parent.subcat)?"Выберите категорию":n.subcat.name},n.choice=function(e){n.subcat=angular.copy(e),t.$parent.$parent.subcat=n.subcat},n.active=function(e){return n.subcat=t.$parent.$parent.subcat,angular.isUndefined(n.subcat)?"":n.subcat.id==e.id?"select-panel__item_active":""},n.catsCount=function(){return n.subcats.length},n.catsChoice=function(t){angular.isUndefined(_.find(n.subcats,{id:t.id}))?n.subcats.push(t):_.remove(n.subcats,function(e){return e.id==t.id})},n.selectedCats=function(){return n.subcats},n.selectedState=function(){var t=n.subcats.length;return 0==t?"Выберите категории":"Выбрано: "+t},n.activeCat=function(t){return angular.isUndefined(_.find(n.subcats,{id:t.id}))?"":"select-panel__item_active"}}]),angular.module("app").controller("cityCtrl",["$scope","dataFab",function(t,e){var n=this;n.city=t.$parent.$parent.city,n.cities=t.$parent.cities,n.districts=function(){return districts=e.getDistricts()},n.districtCities=function(t){return cities=e.getCities(),_.orderBy(_.filter(cities,{district_id:t.id,enabled:1}),"name")},n.selectedCity=function(){return angular.isUndefined(t.$parent.$parent.city)||_.isEmpty(t.$parent.$parent.city)?"Выберите город":n.city.name},n.choice=function(e){n.city=angular.copy(e),t.$parent.$parent.city=n.city},n.active=function(e){return n.city=t.$parent.$parent.city,angular.isUndefined(n.city)?"":n.city.id==e.id?"select-panel__item_active":""},n.citiesCount=function(){return n.cities.length},n.cityChoice=function(t){angular.isUndefined(_.find(n.cities,{id:t.id}))?n.cities.push(t):_.remove(n.cities,function(e){return e.id==t.id})},n.selectedCities=function(){return n.cities},n.selectedState=function(){var t=n.cities.length;return 0==t?"Выберите города":"Выбрано: "+t},n.activeCity=function(t){return angular.isUndefined(_.find(n.cities,{id:t.id}))?"":"select-panel__item_active"}}]),angular.module("app").controller("homeCtrl",function(){}),angular.module("app").controller("managersCtrl",["$http","$location","cons","managersFab","mainFab",function(t,e,n,a,i){function r(t){a.setEnable(t.data.manager),c.disabled=!1}function s(t){401==t.status&&(i.logout(!1),e.path("/signin")),c.disabled=!1}function o(t){a.delete(t.data.manager_id),c.disabled=!1}function l(t){401==t.status&&(i.logout(!1),e.path("/signin")),c.disabled=!1}var c=this;a.load(),c.managers=function(){return a.getManagers()},c.on_off=function(a){var o=i.token();o?c.disabled||(c.disabled=!0,t.post(n.api_path+"manager_on"+o,{id:a.id,enabled:!a.enabled}).then(r,s)):(i.logout(!1),e.path("/signin"))},c.delete=function(a){var r=i.token();r?c.disabled||(c.disabled=!0,t.post(n.api_path+"manager_delete"+r,{id:a.id}).then(o,l)):(i.logout(!1),e.path("/signin"))}}]),angular.module("app").controller("messagesCtrl",["messagesFab",function(t){var e=this;t.load(),e.messages=function(){return t.getMessages()}}]),angular.module("app").controller("regCtrl",["$http","$location","$scope","cons","mainFab","managersFab",function(t,e,n,a,i,r){function s(t){if(i.token()){var e={};e.id=t.data.manager_id,e.company=u.company,e.address=u.address,e.inn=u.inn,e.site=u.site,e.subcats=n.subcats,e.cities=n.cities,e.description=u.description,e.surname=u.surname,e.name=u.name,e.middle_name=u.middle_name,e.post=u.post,e.phone=u.phone,e.mobile=u.mobile,e.email=u.email,r.addManager(e),e=void 0,angular.isUndefined(u.mans)||(u.mans.showAdd=!1),u.catCtrl.subcats=[],u.cityCtrl.cities=[]}u.msg="Менеджер и его компания успешно добавлены. Заявки начнут приходить после этапа модерации.",u.company=void 0,u.address=void 0,u.inn=void 0,u.site=void 0,u.description=void 0,u.surname=void 0,u.name=void 0,u.middle_name=void 0,u.post=void 0,u.phone=void 0,u.mobile=void 0,u.email=void 0,n.subcats=[],n.cities=[],u.disabled=!1,u.form.$setPristine(),window.scrollTo(0,u.pageY)}function o(t){u.manager.company=u.editing.company,u.manager.address=u.editing.address,u.manager.inn=u.editing.inn,u.manager.site=u.editing.site,u.manager.subcats=u.editing.subcats,u.manager.cities=u.editing.cities,u.manager.description=u.editing.description,u.manager.surname=u.editing.surname,u.manager.name=u.editing.name,u.manager.middle_name=u.editing.middle_name,u.manager.post=u.editing.post,u.manager.phone=u.editing.phone,u.manager.mobile=u.editing.mobile,u.manager.email=u.editing.email,u.isEditing=!1,u.editing=null,u.editBtn="Edit",u.disabled=!1,window.scrollTo(0,u.pageY)}function l(t){401==t.status&&(i.logout(!1),e.path("/signin")),angular.isArray(t.data)?u.msg=_.join(t.data," "):429==t.status?u.msg="Слишком много попыток. Подождите минуту!":u.msg="Ошибка: "+t.data,u.disabled=!1}function c(t){return _.map(t,function(t){return t.id})}function d(t){return _.map(t,function(t){return t.id})}var u=this;u.pageY=window.pageYOffset,u.manSet=function(t){u.mans=t},u.catSet=function(t){u.catCtrl=t},u.citySet=function(t){u.cityCtrl=t},angular.isUndefined(u.mans)||(u.mans.showAdd=!1),u.submit=function(e){u.disabled=!0,t.post(a.api_path+"manager",{company:u.company,address:u.address,inn:u.inn,site:u.site,categories:c(n.subcats),cities:d(n.cities),description:u.description,surname:u.surname,name:u.name,middle_name:u.middle_name,post:u.post,phone:u.phone,mobile:u.mobile,email:u.email}).then(s,l),u.form=e},u.formDisabled=function(){return u.disabled},u.update=function(n){var r=i.token();r?(u.disabled=!0,t.post(a.api_path+"manager_update"+r,{id:u.editing.id,company:u.editing.company,address:u.editing.address,inn:u.editing.inn,site:null==u.editing.site?void 0:u.editing.site,categories:c(u.editing.subcats),cities:d(u.editing.cities),description:u.editing.description,surname:u.editing.surname,name:u.editing.name,middle_name:null==u.editing.middle_name?void 0:u.editing.middle_name,post:u.editing.post,phone:u.editing.phone,mobile:null==u.editing.mobile?void 0:u.editing.mobile,email:u.editing.email}).then(o,l),u.form=n):(i.logout(!1),e.path("/signin"))},n.subcat={},n.subcats=[],n.city={},n.cities=[],u.customEmpty=function(){return!(!angular.isUndefined(n.cities)&&0!=n.cities.length)||!(!angular.isUndefined(n.subcats)&&0!=n.subcats.length)},u.msg="",u.showMsg=function(){return""!=u.msg},u.msgClose=function(){u.msg=""},u.isEditing=!1,u.editing=null,u.editBtn="Edit",u.edit=function(t){u.isEditing?(u.isEditing=!1,u.editing=null,u.editBtn="Edit",window.scrollTo(0,u.pageY)):(u.pageY=window.pageYOffset,u.isEditing=!0,u.editBtn="Cancel",u.editing=angular.copy(t),u.manager=t,n.subcats=u.editing.subcats,n.cities=u.editing.cities)}}]),angular.module("app").controller("selecCtrl",["$scope",function(t){this.opened=0,this.open=function(t){0==this.opened?this.opened=t:this.opened=0},this.openClass=function(t){return 0==this.opened?"":this.opened==t?"opened":"closed"}}]),angular.module("app").controller("signinCtrl",["$http","$location","cons","vals","mainFab",function(t,e,n,a,i){function r(t){i.loginRecord(t.data),o.msg="",o.name=void 0,o.password=void 0,o.disabled=!1,e.path("/tenders")}function s(t){angular.isArray(t)?o.msg=_.join(t.data," "):429==t.status?o.msg="Слишком много попыток. Подождите минуту!":o.msg="Ошибка: "+t.data,o.disabled=!1}var o=this;o.submit=function(){o.disabled=!0,t.post(n.api_path+"signin",{name:o.name,password:o.password}).then(r,s)},o.formDisabled=function(){return o.disabled}}]),angular.module("app").controller("sorryCtrl",function(){}),angular.module("app").controller("tendersCtrl",["$location","mainFab","tendersFab",function(t,e,n){var a=this;n.load(),a.tenders=function(){return n.getTenders()},a.getDate=function(t){return new Date(t)}}]),angular.module("app").controller("topCtrl",["$http","$scope","cons","vals",function(t,e,n,a){function i(t){s.msg="Ваша заявка была успешно отправлена! Спасибо, что воспользовались сервисом МИКРОТЕНДЕР.РФ Вы можете продолжить и отправить новую заявку!",s.order=void 0,s.budget=void 0,e.subcat={},e.city={},s.disabled=!1,s.form.$setPristine()}function r(t){angular.isArray(t)?s.msg=_.join(t.data," "):429==t.status?s.msg="Слишком много попыток. Подождите минуту!":s.msg="Ошибка: "+t.data,s.disabled=!1}var s=this;s.attachFile=function(){angular.element(document.querySelector("#fileInput")).triggerHandler("click")},s.submit=function(a){s.disabled=!0,t.post(n.api_path+"tender",{category_id:e.subcat.id,city_id:e.city.id,text:s.order,budjet:s.budget,price:o,name:s.name,email:s.email,phone:s.phone,attach:s.attach}).then(i,r),s.form=a},s.formDisabled=function(){return s.disabled};var o=!1;s.priceToggle=function(){o=!o},s.priceState=function(){return o?"checked":""},e.subcat={},e.subcats=[],e.city={},e.cities=[],s.customEmpty=function(){return!(!angular.isUndefined(e.city)&&!_.isEmpty(e.city))||!(!angular.isUndefined(e.subcat)&&!_.isEmpty(e.subcat))},s.msg="",s.showMsg=function(){return""!=s.msg},s.msgClose=function(){s.msg=""}}]),angular.module("app").controller("wantCtrl",function(){}),angular.module("app").directive("frm",function(){return{restrict:"A",scope:{frm:"@",ctrl:"="},link:function(t,e,n){var a=n.frm,i=n.ctrl;e.attr("name",a),e.attr("ng-submit",i+".submit("+a+")"),e.attr("novalidate","")}}}),angular.module("app").directive("inpt",["cons",function(t){return{restrict:"E",replace:!0,templateUrl:t.lang+"/inpt.html",scope:{},compile:function(t,e){return{pre:function(t,e,n){var a=e.parent();t.ctrl=a.controller(),t.form_name=a.attr("frm"),t.ctrl_name=a.attr("ctrl"),t.label=n.label,e.removeAttr("label");var i=n.help,r=e.find("span");angular.isUndefined(i)||""==i?r.remove():(r.text(i),e.removeAttr("help"));var s=e.find("input");s.attr("ng-model",t.ctrl_name+"."+n.model),e.removeAttr("model"),angular.isUndefined(e.attr("required"))||(s.attr("required",""),e.removeAttr("required")),t.inptDisabled=function(){return t.ctrl.disabled};var o=n.type;switch(e.removeAttr("type"),o){case"text":s.attr("type","text");break;case"email":s.attr("type","email"),s.attr("ng-minlength","7");break;case"phone":s.attr("type","text"),s.attr("ng-minlength","4"),s.prop("ng-pattern","/^[ 0-9+()-]{5,15}$/");break;default:s.attr("type","text")}},post:function(t,e,n){}}}}}]),angular.module("app").directive("msg",["cons",function(t){return{restrict:"E",replace:!0,templateUrl:t.lang+"/msg.html",scope:{},link:function(t,e,n){var a=e.parent();a.attr("frm"),a.attr("ctrl");t.ctrl=a.controller(),t.msgShow=function(){return""!=t.ctrl.msg},t.msgClose=function(){t.ctrl.msg=""}}}}]),angular.module("app").directive("textArea",function(){var t={ENTER:13,CTRL:17,ESC:27},e=!1;return{restrict:"A",link:function(n,a,i){a.on("keyup",function(n){n.keyCode===t.CTRL&&(e=!1)}),a.on("keydown",function(a){a.keyCode===t.CTRL&&(e=!0),n.form.$valid&&a.keyCode===t.ENTER&&e&&n.ctrl.submit(n.form)}),a.on("input",function(){var t=a.val();t=t.replace(/\n/g,"<br>");var e=a.next();e.html(t+" "),e.css("width",a[0].offsetWidth+"px"),a.css("height",e[0].offsetHeight+"px")})},scope:{form:"=",ctrl:"="}}}),angular.module("app").directive("txar",["cons",function(t){var e={ENTER:13,CTRL:17,ESC:27},n=!1;return{restrict:"E",replace:!0,templateUrl:t.lang+"/txar.html",scope:{},link:function(t,a,i){var r=a.parent();t.ctrl=r.controller(),t.form_name=r.attr("frm"),t.ctrl_name=r.attr("ctrl"),t.label=i.label,t.help=i.help;var s=a.find("textarea");s.attr("ng-model",t.ctrl_name+"."+i.model),angular.isUndefined(a.attr("required"))||(s.attr("required",""),a.removeAttr("required")),t.txarDisabled=function(){return t.ctrl.disabled},s.on("keyup",function(t){t.keyCode===e.CTRL&&(n=!1)}),s.on("keydown",function(t){t.keyCode===e.CTRL&&(n=!0),t.keyCode===e.ENTER&&n});var o=angular.element("<div>");o.addClass("hiddendiv");var l=angular.element(document.querySelector("body"));l.append(o),s.on("input",function(){var t=s.val();t=t.replace(/\n/g,"<br>"),o.html(t+" "),o.css("width",s.css("width")),s.css("min-height",o.css("height"))})}}}]);